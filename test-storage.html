<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­˜å‚¨ç³»ç»Ÿæµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      line-height: 1.6;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .test-section h3 {
      margin-top: 0;
      color: #333;
    }
    button {
      background: #4a90d9;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #357abd;
    }
    .result {
      margin: 10px 0;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    .success { color: green; }
    .error { color: red; }
    .info { color: blue; }
  </style>
</head>
<body>
  <h1>ğŸ“ File System API å­˜å‚¨ç³»ç»Ÿæµ‹è¯•</h1>

  <div class="test-section">
    <h3>1. å­˜å‚¨ç³»ç»Ÿä¿¡æ¯</h3>
    <button onclick="testStorageInfo()">æ£€æŸ¥å­˜å‚¨ç³»ç»Ÿ</button>
    <div id="storage-info" class="result"></div>
  </div>

  <div class="test-section">
    <h3>2. åˆ›å»ºæµ‹è¯•æ•°æ®</h3>
    <button onclick="testCreate()">åˆ›å»ºæµ‹è¯•æ—¥è®°</button>
    <div id="create-result" class="result"></div>
  </div>

  <div class="test-section">
    <h3>3. è¯»å–æ•°æ®</h3>
    <button onclick="testRead()">è¯»å–æ‰€æœ‰æ—¥è®°</button>
    <div id="read-result" class="result"></div>
  </div>

  <div class="test-section">
    <h3>4. æ›´æ–°æ•°æ®</h3>
    <button onclick="testUpdate()">æ›´æ–°ç¬¬ä¸€æ¡æ—¥è®°</button>
    <div id="update-result" class="result"></div>
  </div>

  <div class="test-section">
    <h3>5. åˆ é™¤æ•°æ®</h3>
    <button onclick="testDelete()">åˆ é™¤æœ€åä¸€æ¡æ—¥è®°</button>
    <div id="delete-result" class="result"></div>
  </div>

  <div class="test-section">
    <h3>6. å‡çº§åˆ°æ–‡ä»¶å­˜å‚¨</h3>
    <button onclick="testUpgrade()">å‡çº§å­˜å‚¨æ¨¡å¼</button>
    <div id="upgrade-result" class="result"></div>
  </div>

  <script src="config/env.js"></script>
  <script src="js/storage.js"></script>
  <script>
    let testStorage = null;

    async function log(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
      el.textContent = `${prefix} [${timestamp}] ${message}`;
      el.className = `result ${type}`;
    }

    async function testStorageInfo() {
      try {
        testStorage = new DiaryStorage();
        await testStorage.init();

        const info = {
          isSupported: 'showSaveFilePicker' in window,
          useFileSystem: testStorage.useFileSystem,
          hasDiaryHandle: !!testStorage.fs.diaryHandle,
          diaryFileName: testStorage.fs.diaryHandle ? testStorage.fs.diaryHandle.name : 'N/A',
          storageMode: testStorage.fs.storageMode
        };

        log('storage-info', JSON.stringify(info, null, 2), 'success');
      } catch (error) {
        log('storage-info', error.message, 'error');
      }
    }

    async function testCreate() {
      try {
        if (!testStorage) {
          testStorage = new DiaryStorage();
          await testStorage.init();
        }

        const testDiary = {
          content: `è¿™æ˜¯æµ‹è¯•æ—¥è®° - ${new Date().toLocaleString()}`,
          title: 'æµ‹è¯•æ—¥è®°'
        };

        const created = await testStorage.create(testDiary);
        log('create-result', `åˆ›å»ºæˆåŠŸï¼\nID: ${created.id}\næ ‡é¢˜: ${created.title}\nå†…å®¹: ${created.content}`, 'success');
      } catch (error) {
        log('create-result', `åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testRead() {
      try {
        if (!testStorage) {
          testStorage = new DiaryStorage();
          await testStorage.init();
        }

        const diaries = await testStorage.getAll();
        const count = diaries.length;
        const first = diaries[0];

        log('read-result', `æ‰¾åˆ° ${count} æ¡æ—¥è®°\nç¬¬ä¸€æ¡: ${first ? first.title : 'N/A'}`, 'success');
      } catch (error) {
        log('read-result', `è¯»å–å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testUpdate() {
      try {
        if (!testStorage) {
          testStorage = new DiaryStorage();
          await testStorage.init();
        }

        const diaries = await testStorage.getAll();
        if (diaries.length === 0) {
          log('update-result', 'æ²¡æœ‰æ—¥è®°å¯æ›´æ–°', 'error');
          return;
        }

        const first = diaries[0];
        const updated = await testStorage.update(first.id, {
          title: `å·²æ›´æ–° - ${new Date().toLocaleTimeString()}`
        });

        log('update-result', `æ›´æ–°æˆåŠŸï¼\næ–°æ ‡é¢˜: ${updated.title}`, 'success');
      } catch (error) {
        log('update-result', `æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testDelete() {
      try {
        if (!testStorage) {
          testStorage = new DiaryStorage();
          await testStorage.init();
        }

        const diaries = await testStorage.getAll();
        if (diaries.length === 0) {
          log('delete-result', 'æ²¡æœ‰æ—¥è®°å¯åˆ é™¤', 'error');
          return;
        }

        const last = diaries[diaries.length - 1];
        await testStorage.delete(last.id);

        log('delete-result', `åˆ é™¤æˆåŠŸï¼\nå·²åˆ é™¤: ${last.title}`, 'success');
      } catch (error) {
        log('delete-result', `åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testUpgrade() {
      try {
        if (!testStorage) {
          testStorage = new DiaryStorage();
          await testStorage.init();
        }

        if (!testStorage.fs.isSupported) {
          log('upgrade-result', 'æµè§ˆå™¨ä¸æ”¯æŒ File System API', 'error');
          return;
        }

        if (testStorage.useFileSystem) {
          log('upgrade-result', 'å·²ç»æ˜¯æ–‡ä»¶å­˜å‚¨æ¨¡å¼äº†', 'success');
          return;
        }

        const success = await testStorage.enableFileSystem();
        if (success) {
          log('upgrade-result', 'å‡çº§æˆåŠŸï¼å·²åˆ‡æ¢åˆ°æ–‡ä»¶å­˜å‚¨æ¨¡å¼', 'success');
        } else {
          log('upgrade-result', 'å‡çº§å¤±è´¥', 'error');
        }
      } catch (error) {
        log('upgrade-result', `å‡çº§å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // Auto-test storage info on load
    window.addEventListener('DOMContentLoaded', testStorageInfo);
  </script>
</body>
</html>
