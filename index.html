<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="智能日记本 - AI情感分析与积极改写">
  <title>智能日记本</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4a90d9">
</head>
<body>
  <div id="app" class="container">
    <header class="header">
      <h1>智能日记本</h1>
      <div class="status-bar">
        <span id="status-online" class="status-online">在线</span>
        <span id="status-queue" class="status-queue" style="display: none;">
          队列: <span id="status-count">0</span>
        </span>
      </div>
    </header>

    <main>
      <div id="view-list" class="view">
        <div class="diary-list-header" style="margin-bottom: 20px;">
          <div class="header-left">
            <button id="btn-new" class="btn btn-primary">写新日记</button>
            <button id="btn-weekly" class="btn btn-secondary">📖 周记</button>
          </div>
          <div class="header-right">
            <a class="btn btn-secondary" href="https://www.imgurl.org/upload" target="_blank">图床</a>
            <button id="btn-settings" class="btn btn-secondary">设置</button>
          </div>
        </div>
        <div id="diary-list" class="diary-list">
        </div>
      </div>

      <div id="view-weekly" class="view view-weekly hidden">
        <div class="weekly-header">
          <h2>周记本</h2>
          <div class="weekly-header-actions">
            <button id="btn-weekly-create" class="btn btn-primary btn-small">生成周记</button>
            <button id="btn-back-to-list" class="btn btn-secondary btn-small">返回日记</button>
          </div>
        </div>
        <div id="weekly-list" class="weekly-list">
        </div>
      </div>

      <div id="view-editor" class="view view-editor hidden">
        <div class="editor-header">
          <input type="text" id="editor-title" class="editor-title-input" placeholder="日记标题（可选）">
          <button id="btn-back" class="btn btn-secondary btn-small">返回列表</button>
        </div>
        <div class="editor-toolbar">
          <button id="btn-insert-image" class="btn btn-secondary btn-small" title="插入图片">📷 插入图片</button>
          <button id="btn-upload-image" class="btn btn-secondary btn-small" title="上传图片">⬆️ 上传图片</button>
          <button id="btn-view-original" class="btn btn-secondary btn-small">查看原文</button>
        </div>
        <div id="image-upload-status" class="upload-status hidden">
          <span id="image-upload-text">上传中 0%</span>
          <button id="btn-retry-upload" class="btn btn-secondary btn-small hidden">重试</button>
        </div>
        <div id="editor-images" class="editor-images hidden"></div>
        <textarea id="editor-content" class="editor-content" placeholder="今天发生了什么？写下你的心情和想法..."></textarea>

        <div id="analysis-progress" class="analysis-progress hidden">
          <div class="progress-header">
            <span class="progress-spinner"></span>
            <span id="progress-status">正在分析...</span>
          </div>
          <div class="progress-bar-container">
            <div id="progress-bar" class="progress-bar"></div>
          </div>
          <div id="progress-info" class="progress-info">准备中</div>
          <button id="btn-cancel-analysis" class="btn btn-secondary btn-small">取消</button>
        </div>

        <div class="editor-footer">
          <span id="word-count" class="word-count">0 字</span>
          <div class="editor-actions">
            <button id="btn-save" class="btn btn-primary">乐观分析</button>
            <button id="btn-structure" class="btn btn-secondary">结构优化</button>
            <button id="btn-save-only" class="btn btn-secondary">仅保存</button>
          </div>
        </div>
      </div>

      <div id="view-settings" class="view view-settings hidden">
        <h2>设置</h2>
        <div class="settings-form">
          <div class="form-group">
            <label for="settings-api-key">智谱AI API Key</label>
            <input type="password" id="settings-api-key" placeholder="输入你的API Key">
            <p style="margin-top: 8px; color: var(--text-secondary); font-size: 0.85rem;">
              请前往 <a href="https://www.bigmodel.cn/" target="_blank">智谱AI开放平台</a> 获取API Key
            </p>
          </div>
          <button id="btn-api-key" class="btn btn-primary">保存API Key</button>
          <div class="form-group" style="margin-top: 24px;">
            <label for="settings-imgurl-base-url">ImgURL Base URL</label>
            <input type="text" id="settings-imgurl-base-url" placeholder="https://www.imgurl.org">
          </div>
          <div class="form-group">
            <label for="settings-imgurl-uid">ImgURL UID (V2 可选)</label>
            <input type="text" id="settings-imgurl-uid" placeholder="如果使用 sk- Token，请填写 UID">
          </div>
          <div class="form-group">
            <label for="settings-imgurl-token">ImgURL Token</label>
            <input type="password" id="settings-imgurl-token" placeholder="sk-xxx (V2) 或 web-xxx (V3)">
            <p style="margin-top: 8px; color: var(--text-secondary); font-size: 0.85rem;">
              自动识别 Token 类型：web- 开头自动走 V3 接口，sk- 开头走 V2 接口（需填写 UID）。
            </p>
          </div>
          <div class="settings-actions">
            <button id="btn-save-imgurl" class="btn btn-primary">保存图床配置</button>
            <button id="btn-test-imgurl" class="btn btn-secondary">测试连接</button>
          </div>
          <div id="imgurl-test-status" class="settings-status"></div>
          <button id="btn-back-from-settings" class="btn btn-secondary">返回主页</button>
        </div>

        <div class="backup-section">
          <h3>数据备份</h3>
          <div class="backup-buttons">
            <button class="btn btn-secondary" onclick="exportData()">导出数据</button>
            <button class="btn btn-secondary" onclick="importData()">导入数据</button>
          </div>
        </div>
      </div>
    </main>

    <div id="modal-analysis" class="modal-overlay hidden">
      <div class="modal">
        <div class="modal-header">
          <h2>情感分析结果</h2>
          <button id="btn-close-modal" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="analysis-label">原文（负面句子已标记，悬停查看改写建议）</div>
          <div id="analysis-content" class="analysis-content"></div>
          <div class="analysis-label">积极改写版本</div>
          <div id="analysis-rewritten" class="analysis-rewritten"></div>
        </div>
        <div class="modal-footer">
          <button id="btn-regenerate-analysis" class="btn btn-secondary">重新生成</button>
          <button id="btn-minimize-modal" class="btn btn-secondary">最小化</button>
          <button id="btn-keep-original" class="btn btn-secondary">保留原文</button>
          <button id="btn-use-rewritten" class="btn btn-primary">采用改写</button>
        </div>
      </div>
    </div>

    <div id="modal-structure" class="modal-overlay hidden">
      <div class="modal">
        <div class="modal-header">
          <h2>结构优化结果</h2>
          <button id="btn-close-structure" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div id="structure-content" class="structure-content"></div>
        </div>
        <div class="modal-footer">
          <button id="btn-cancel-structure" class="btn btn-secondary">取消</button>
          <button id="btn-use-structure" class="btn btn-primary">采用优化</button>
        </div>
      </div>
    </div>

    <div id="modal-original" class="modal-overlay hidden">
      <div class="modal">
        <div class="modal-header">
          <h2>原文内容</h2>
          <button id="btn-close-original" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div id="original-content" class="original-content"></div>
        </div>
        <div class="modal-footer">
          <button id="btn-close-original-footer" class="btn btn-secondary">关闭</button>
        </div>
      </div>
    </div>

    <div id="modal-viewer" class="modal-overlay viewer-overlay hidden">
      <div class="viewer-header">
        <div class="viewer-controls-left">
          <button class="viewer-btn" onclick="ui.setViewerTheme('light')" title="浅色模式">☀</button>
          <button class="viewer-btn" onclick="ui.setViewerTheme('dark')" title="深色模式">☾</button>
          <button class="viewer-btn" onclick="ui.setViewerTheme('warm')" title="护眼模式">◐</button>
        </div>
        <div class="viewer-controls-center">
          <span class="viewer-font-controls">
            <button class="viewer-btn viewer-font-btn" onclick="ui.adjustViewerFontSize(-2)">A-</button>
            <span id="viewer-font-size">18px</span>
            <button class="viewer-btn viewer-font-btn" onclick="ui.adjustViewerFontSize(2)">A+</button>
          </span>
        </div>
        <div class="viewer-controls-right">
          <button id="btn-prev-diary" class="viewer-btn" onclick="ui.navigateViewer('prev')">← 上一篇</button>
          <button id="btn-next-diary" class="viewer-btn" onclick="ui.navigateViewer('next')">下一篇 →</button>
          <button class="viewer-btn viewer-close-btn" onclick="ui.closeViewer()">✕</button>
        </div>
      </div>
      <div class="viewer-content-wrapper">
        <article id="viewer-article" class="viewer-article">
        </article>
      </div>
    </div>

    <div id="modal-insert-image" class="modal-overlay hidden">
      <div class="modal">
        <div class="modal-header">
          <h2>插入图片</h2>
          <button id="btn-close-image-modal" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="image-url-input">图片链接</label>
            <input type="text" id="image-url-input" class="form-control" placeholder="请输入图片 URL (例如: https://example.com/image.jpg)">
          </div>
        </div>
        <div class="modal-footer">
          <button id="btn-cancel-insert" class="btn btn-secondary">取消</button>
          <button id="btn-confirm-insert" class="btn btn-primary">确认插入</button>
        </div>
      </div>
    </div>

    <div id="modal-weekly" class="modal-overlay weekly-modal-overlay hidden">
      <div class="weekly-modal">
        <div class="weekly-modal-header">
          <h2 id="weekly-modal-title">周记生成</h2>
          <button id="btn-close-weekly" class="modal-close">&times;</button>
        </div>
        <div id="weekly-modal-body" class="weekly-modal-body">
          <div id="weekly-selector" class="weekly-selector">
            <div class="weekly-selector-controls">
              <div class="weekly-control-row">
                <label for="weekly-select-mode">选择方式</label>
                <select id="weekly-select-mode" class="weekly-control-select">
                  <option value="range">自然周/日期范围</option>
                  <option value="manual">手动选择</option>
                </select>
              </div>
              <div id="weekly-range-controls" class="weekly-control-row">
                <label for="weekly-range-type">选择范围</label>
                <select id="weekly-range-type" class="weekly-control-select">
                  <option value="last-week">上周（周一至周日）</option>
                  <option value="this-week">本周（周一至周日）</option>
                  <option value="custom">自定义日期</option>
                </select>
              </div>
              <div id="weekly-custom-range" class="weekly-control-row hidden">
                <label>自定义区间</label>
                <div class="weekly-date-range">
                  <input type="date" id="weekly-range-start" class="weekly-date-input">
                  <span class="weekly-date-separator">至</span>
                  <input type="date" id="weekly-range-end" class="weekly-date-input">
                </div>
              </div>
            </div>
            <div class="weekly-selection-summary">
              <span id="weekly-selected-count">已选 0 篇</span>
              <span id="weekly-selected-range"></span>
            </div>
            <div id="weekly-diary-list" class="weekly-diary-list"></div>
            <div id="weekly-selection-tip" class="weekly-selection-tip"></div>
          </div>
          <div id="weekly-editor" class="weekly-editor hidden">
            <label class="weekly-editor-label">周记标题</label>
            <input id="weekly-editor-title" class="weekly-editor-input" type="text" placeholder="输入周记标题">
            <label class="weekly-editor-label">周记内容</label>
            <div class="editor-toolbar">
              <button id="btn-weekly-insert-image" class="btn btn-secondary btn-small" title="插入图片">📷 插入图片</button>
              <button id="btn-weekly-upload-image" class="btn btn-secondary btn-small" title="上传图片">⬆️ 上传图片</button>
            </div>
            <div id="weekly-upload-status" class="upload-status hidden">
              <span id="weekly-upload-text">上传中 0%</span>
              <button id="btn-weekly-retry-upload" class="btn btn-secondary btn-small hidden">重试</button>
            </div>
            <div id="weekly-editor-images" class="editor-images hidden"></div>
            <textarea id="weekly-editor-summary" class="editor-content weekly-editor-textarea" placeholder="输入周记内容"></textarea>
          </div>
          <div id="weekly-progress" class="weekly-progress hidden">
            <div class="progress-header">
              <span class="progress-spinner"></span>
              <span id="weekly-progress-status">正在生成周记...</span>
            </div>
            <div class="progress-bar-container">
              <div id="weekly-progress-bar" class="progress-bar"></div>
            </div>
            <div id="weekly-progress-info" class="progress-info">准备中</div>
          </div>
          <div id="weekly-result" class="weekly-result hidden">
            <div id="weekly-title" class="weekly-title"></div>
            <div id="weekly-result-images" class="editor-images hidden"></div>
            <div id="weekly-summary" class="weekly-summary"></div>
          </div>
          <div id="weekly-empty" class="weekly-empty hidden">
          </div>
        </div>
        <div id="weekly-selection-footer" class="weekly-selection-footer">
          <div class="weekly-selection-actions">
            <button id="btn-weekly-select-all" class="btn btn-secondary btn-small">全选</button>
            <button id="btn-weekly-clear" class="btn btn-secondary btn-small">清空</button>
          </div>
          <button id="btn-generate-weekly" class="btn btn-primary">生成周记</button>
        </div>
        <div id="weekly-editor-footer" class="weekly-editor-footer hidden">
          <button id="btn-cancel-weekly-edit" class="btn btn-secondary">取消</button>
          <button id="btn-save-weekly-edit" class="btn btn-primary">保存修改</button>
        </div>
        <div id="weekly-modal-footer" class="weekly-modal-footer hidden">
          <button id="btn-edit-weekly" class="btn btn-secondary">编辑</button>
          <button id="btn-weekly-structure" class="btn btn-secondary">结构分析</button>
          <button id="btn-regenerate-weekly" class="btn btn-secondary">重新生成</button>
          <button id="btn-save-weekly" class="btn btn-primary">保存周记</button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast"></div>
  </div>

  <input type="file" id="image-upload-input" accept="image/*" class="hidden">

  <script src="config/env.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/api.js"></script>
  <script src="js/offline.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
